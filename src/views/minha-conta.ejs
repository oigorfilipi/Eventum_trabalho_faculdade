<%# Arquivo: src/views/minha-conta.ejs Este arquivo mostra dois layouts diferentes: 1. Se user.role=='admin' , mostra
    o 'stats' (Painel de Controle). 2. Sen√£o, mostra 'myEvents' e infos do usu√°rio (Perfil). %>

    <%- include('partials/header', { title: 'Minha Conta' }) %>

        <div class="container">

            <%# Exibe mensagens de erro/sucesso %>
                <% if (message) { %>
                    <div class="flash-message <%= message.type %>" style="margin-bottom: 1.5rem;">
                        <%= message.text %>
                    </div>
                    <% } %>

                        <%# --------------------------------------------------- %>
                            <%# 1. VIS√ÉO DO ADMIN (Permanece igual) %>
                                <%# --------------------------------------------------- %>
                                    <% if (user.role==='admin' ) { %>
                                        <h1>Painel de Controle</h1>
                                        <p>Ol√°, admin <%= user.name %>. Aqui est√° um resumo do sistema.</p>

                                        <div class="form-container form-container-wide" style="margin-top: 2rem;">
                                            <h2>Estat√≠sticas R√°pidas</h2>
                                            <div class="admin-stats">
                                                <div class="stat-card">
                                                    <h3>
                                                        <%= stats.users %>
                                                    </h3>
                                                    <p>Usu√°rios Totais</p>
                                                </div>
                                                <div class="stat-card">
                                                    <h3>
                                                        <%= stats.events %>
                                                    </h3>
                                                    <p>Eventos Ativos</p>
                                                </div>
                                                <div class="stat-card">
                                                    <h3>
                                                        <%= stats.activeSubscriptions %>
                                                    </h3>
                                                    <p>Inscri√ß√µes Ativas</p>
                                                </div>
                                                <div class="stat-card">
                                                    <h3>
                                                        <%= stats.totalSubscriptions %>
                                                    </h3>
                                                    <p>Inscri√ß√µes Totais (Hist√≥rico)</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-container form-container-wide" style="margin-top: 2rem;">
                                            <h2>A√ß√µes de Admin</h2>
                                            <div class="form-actions"
                                                style="flex-direction: column; align-items: stretch;">
                                                <a href="/site/eventos/novo" class="btn btn-success"
                                                    style="text-align: center;">+ Criar Novo Evento</a>
                                                <a href="/site/eventos/todos" class="btn btn-secondary"
                                                    style="text-align: center;">Gerenciar Eventos Existentes</a>
                                                <a href="/site/relatorio-admin" target="_blank"
                                                    class="btn btn-secondary" style="text-align: center;">Imprimir
                                                    Relat√≥rio Geral</a>
                                                <a href="/site/admin/mensagens" class="btn btn-secondary"
                                                    style="text-align: center;">Ver Mensagens de Contato</a>
                                            </div>
                                        </div>

                                        <div class="form-container form-container-wide" style="margin-top: 2rem;">
                                            <h2>Gerar Certificados</h2>
                                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                                                Selecione um evento para gerar um certificado para todos os usu√°rios
                                                inscritos.
                                            </p>
                                            <div class="certificate-list">
                                                <% if (events && events.length> 0) { %>
                                                    <% events.forEach(event=> { %>
                                                        <div class="certificate-item">
                                                            <span>
                                                                <%= event.title %>
                                                            </span>
                                                            <a href="/site/certificados/<%= event.id %>"
                                                                class="btn btn-secondary" target="_blank">Gerar</a>
                                                        </div>
                                                        <% }) %>
                                                            <% } else { %>
                                                                <p>Nenhum evento criado ainda.</p>
                                                                <% } %>
                                            </div>
                                        </div>

                                        <%# --------------------------------------------------- %>
                                            <%# 2. VIS√ÉO DO USU√ÅRIO (NOVO LAYOUT DE ABAS) %>
                                                <%# --------------------------------------------------- %>
                                                    <% } else { %>
                                                        <h1>Minha Conta</h1>

                                                        <%# --- NAVEGA√á√ÉO DAS ABAS --- %>
                                                            <nav class="tab-navigation">
                                                                <button class="tab-button active"
                                                                    data-target="#tab-meus-dados">Meus Dados</button>
                                                                <button class="tab-button"
                                                                    data-target="#tab-seguranca">Privacidade e
                                                                    Seguran√ßa</button>
                                                                <button class="tab-button"
                                                                    data-target="#tab-meus-eventos">Meus Eventos
                                                                    Inscritos</button>
                                                            </nav>

                                                            <%# --- CONTE√öDO DAS ABAS --- %>

                                                                <%# Aba 1: Meus Dados %>
                                                                    <div class="tab-content active" id="tab-meus-dados">
                                                                        <div class="form-container form-container-wide">
                                                                            <h2>Meus Dados</h2>

                                                                            <form action="/site/atualizar-perfil"
                                                                                method="POST">

                                                                                <div class="form-group">
                                                                                    <label>Nome Completo (N√£o pode ser
                                                                                        alterado):</label>
                                                                                    <input type="text"
                                                                                        class="form-control"
                                                                                        value="<%= user.nome_completo %>"
                                                                                        disabled>
                                                                                </div>

                                                                                <div class="form-group">
                                                                                    <label for="name">Nome Social (Como
                                                                                        prefere ser chamado):</label>
                                                                                    <input type="text" id="name"
                                                                                        name="name" class="form-control"
                                                                                        value="<%= user.name %>"
                                                                                        required disabled>
                                                                                    <%# ADICIONADO 'disabled' %>
                                                                                </div>

                                                                                <div class="form-group">
                                                                                    <label
                                                                                        for="phone-mask">Telefone:</label>
                                                                                    <input type="tel" id="phone-mask"
                                                                                        name="phone"
                                                                                        class="form-control"
                                                                                        placeholder="(00) 0 0000-0000"
                                                                                        value="<%= user.phone || '' %>"
                                                                                        disabled>
                                                                                    <%# ADICIONADO 'disabled' %>
                                                                                </div>

                                                                                <div class="form-group">
                                                                                    <label>Email (N√£o pode ser
                                                                                        alterado):</label>
                                                                                    <input type="email"
                                                                                        class="form-control"
                                                                                        value="<%= user.email %>"
                                                                                        disabled>
                                                                                </div>

                                                                                <%# --- BOT√ïES DE CONTROLE --- %>
                                                                                    <div class="form-actions"
                                                                                        id="profile-actions-view">
                                                                                        <button type="button"
                                                                                            class="btn btn-secondary"
                                                                                            id="edit-profile-btn">Alterar
                                                                                            Dados</button>
                                                                                    </div>

                                                                                    <div class="form-actions hidden"
                                                                                        id="profile-actions-edit">
                                                                                        <button type="submit"
                                                                                            class="btn btn-success">Salvar
                                                                                            Altera√ß√µes</button>
                                                                                        <button type="button"
                                                                                            class="btn btn-secondary"
                                                                                            id="cancel-profile-btn">Cancelar</button>
                                                                                    </div>
                                                                            </form>
                                                                        </div>
                                                                    </div>

                                                                    <%# Aba 2: Privacidade e Seguran√ßa %>
                                                                        <div class="tab-content" id="tab-seguranca">

                                                                            <%# Formul√°rio de Alterar Senha %>
                                                                                <div
                                                                                    class="form-container form-container-wide">
                                                                                    <%# <-- ADICIONE AQUI %>
                                                                                        <h2>Alterar Senha</h2>
                                                                                        <p
                                                                                            style="color: var(--text-secondary); margin-bottom: 1rem;">
                                                                                            A senha deve ter no m√≠nimo 6
                                                                                            d√≠gitos.</p>
                                                                                        <form action="/site/mudar-senha"
                                                                                            method="POST">
                                                                                            <div class="form-group">
                                                                                                <label
                                                                                                    for="senha-atual">Senha
                                                                                                    Atual:</label>
                                                                                                <div
                                                                                                    class="password-wrapper">
                                                                                                    <input
                                                                                                        type="password"
                                                                                                        id="senha-atual"
                                                                                                        name="senhaAtual"
                                                                                                        class="form-control"
                                                                                                        required>
                                                                                                    <button
                                                                                                        type="button"
                                                                                                        class="password-toggle">üëÅÔ∏è</button>
                                                                                                </div>
                                                                                            </div>
                                                                                            <div class="form-group">
                                                                                                <label
                                                                                                    for="nova-senha">Nova
                                                                                                    Senha:</label>
                                                                                                <div
                                                                                                    class="password-wrapper">
                                                                                                    <input
                                                                                                        type="password"
                                                                                                        id="nova-senha"
                                                                                                        name="novaSenha"
                                                                                                        class="form-control"
                                                                                                        required
                                                                                                        minlength="6">
                                                                                                    <button
                                                                                                        type="button"
                                                                                                        class="password-toggle">üëÅÔ∏è</button>
                                                                                                </div>
                                                                                            </div>
                                                                                            <button type="submit"
                                                                                                class="btn btn-secondary">Salvar
                                                                                                Nova Senha</button>
                                                                                        </form>
                                                                                </div>

                                                                                <%# Simula√ß√£o de Termos e 2FA %>
                                                                                    <div class="form-container form-container-wide"
                                                                                        style="margin-top: 2rem;">
                                                                                        <%# <-- ADICIONE AQUI %>
                                                                                            <h2>Termos e Fatores de
                                                                                                Autentica√ß√£o</h2>
                                                                                            <div class="form-group">
                                                                                                <p>Lorem ipsum dolor sit
                                                                                                    amet, consectetur
                                                                                                    adipiscing elit.
                                                                                                    Nullam
                                                                                                    in dui mauris.
                                                                                                    Vivamus
                                                                                                    hendrerit arcu sed
                                                                                                    erat
                                                                                                    molestie vehicula.
                                                                                                    Sed
                                                                                                    auctor neque eu
                                                                                                    tellus
                                                                                                    rhoncus, aenean.</p>
                                                                                            </div>

                                                                                            <%# Formul√°rio simulado %>
                                                                                                <%# CORRE√á√ÉO: Adicionado
                                                                                                    ID ao form %>
                                                                                                    <form
                                                                                                        id="termos-form-simulado">
                                                                                                        <div
                                                                                                            class="form-group checkbox-group">
                                                                                                            <input
                                                                                                                type="checkbox"
                                                                                                                id="termos-check"
                                                                                                                <%=(user.aceitou_termos===1)
                                                                                                                ? 'checked'
                                                                                                                : '' %>
                                                                                                            <%= (user.aceitou_termos===1)
                                                                                                                ? 'disabled'
                                                                                                                : '' %>>
                                                                                                                <label
                                                                                                                    for="termos-check">Eu
                                                                                                                    aceito
                                                                                                                    os
                                                                                                                    termos
                                                                                                                    e
                                                                                                                    condi√ß√µes</label>
                                                                                                        </div>
                                                                                                        <div
                                                                                                            class="form-group checkbox-group">
                                                                                                            <input
                                                                                                                type="checkbox"
                                                                                                                id="2fa-check"
                                                                                                                <%=(user.usa_2fa===1)
                                                                                                                ? 'checked'
                                                                                                                : '' %>
                                                                                                            <%= (user.aceitou_termos===1)
                                                                                                                ? 'disabled'
                                                                                                                : '' %>>
                                                                                                                <label
                                                                                                                    for="2fa-check">Ativar
                                                                                                                    Autentica√ß√£o
                                                                                                                    de
                                                                                                                    Dois
                                                                                                                    Fatores
                                                                                                                    (2FA)</label>
                                                                                                        </div>

                                                                                                        <% if
                                                                                                            (user.aceitou_termos
                                                                                                            !==1) { %>
                                                                                                            <div class="form-actions"
                                                                                                                style="margin-top: 1.5rem;">
                                                                                                                <button
                                                                                                                    type="submit"
                                                                                                                    class="btn btn-secondary"
                                                                                                                    id="salvar-termos-btn">Salvar
                                                                                                                    Prefer√™ncias</button>
                                                                                                            </div>

                                                                                                            <div class="termos-success-msg hidden"
                                                                                                                id="termos-success-msg"
                                                                                                                style="margin-top: 1rem;">
                                                                                                                ‚úì
                                                                                                                Altera√ß√µes
                                                                                                                salvas
                                                                                                                com
                                                                                                                sucesso!
                                                                                                            </div>
                                                                                                            <% } else {
                                                                                                                %>
                                                                                                                <div class="termos-success-msg"
                                                                                                                    id="termos-success-msg"
                                                                                                                    style="margin-top: 1rem;">
                                                                                                                    ‚úì
                                                                                                                    Prefer√™ncias
                                                                                                                    salvas.
                                                                                                                </div>
                                                                                                                <% } %>
                                                                                                    </form>
                                                                                    </div>

                                                                                    <%# Zona de Perigo (Simulada) %>
                                                                                        <div class="form-container danger-zone form-container-wide"
                                                                                            style="margin-top: 2rem;">
                                                                                            <%# <-- ADICIONE AQUI %>
                                                                                                <h2>Zona de Perigo</h2>
                                                                                                <div
                                                                                                    style="display: flex; gap: 1rem; flex-wrap: wrap;">

                                                                                                    <%# --- BOT√ÉO
                                                                                                        DELETAR ATIVADO
                                                                                                        --- %>
                                                                                                        <form
                                                                                                            action="/site/deletar-conta"
                                                                                                            method="POST"
                                                                                                            onsubmit="return confirm('ATEN√á√ÉO: Voc√™ tem certeza que deseja DELETAR sua conta? Esta a√ß√£o √© irrevers√≠vel e todos os seus dados e inscri√ß√µes ser√£o perdidos.');">
                                                                                                            <button
                                                                                                                type="submit"
                                                                                                                class="btn btn-danger">Deletar
                                                                                                                Minha
                                                                                                                Conta</button>
                                                                                                        </form>

                                                                                                </div>
                                                                                        </div>
                                                                        </div>

                                                                        <%# Aba 3: Meus Eventos Inscritos %>
                                                                            <div class="tab-content"
                                                                                id="tab-meus-eventos">
                                                                                <%# Se√ß√£o "Meus Eventos Inscritos" %>
                                                                                    <div
                                                                                        class="form-container form-container-wide">
                                                                                        <%# <-- ADICIONE AQUI %>
                                                                                            <h1>Meus Eventos Inscritos
                                                                                            </h1>
                                                                                            <% if (myEvents &&
                                                                                                myEvents.length> 0) { %>
                                                                                                <div class="event-list">
                                                                                                    <%
                                                                                                        myEvents.forEach(event=>
                                                                                                        { %>
                                                                                                        <div
                                                                                                            class="event-card">
                                                                                                            <% if
                                                                                                                (event.cover_image_url)
                                                                                                                { %>
                                                                                                                <a href="/site/eventos/<%= event.id %>"
                                                                                                                    class="event-card-image-link"
                                                                                                                    aria-hidden="true"
                                                                                                                    tabindex="-1">
                                                                                                                    <img src="<%= event.cover_image_url %>"
                                                                                                                        alt=""
                                                                                                                        class="event-card-image-novo">
                                                                                                                </a>
                                                                                                                <% } %>
                                                                                                                    <div class="event-card-content"
                                                                                                                        style="display: flex; flex-direction: column; flex-grow: 1;">
                                                                                                                        <a href="/site/eventos/<%= event.id %>"
                                                                                                                            class="event-title-link">
                                                                                                                            <h3>
                                                                                                                                <%= event.title
                                                                                                                                    %>
                                                                                                                            </h3>
                                                                                                                        </a>
                                                                                                                        <p
                                                                                                                            style="color: var(--success-color); font-weight: bold; margin-top: auto;">
                                                                                                                            ‚úì
                                                                                                                            Inscrito
                                                                                                                        </p>

                                                                                                                        <div class="form-actions"
                                                                                                                            style="margin-top: 1rem; width: 100%; justify-content: space-between; gap: 0.5rem;">

                                                                                                                            <a href="/site/meu-certificado/<%= event.id %>"
                                                                                                                                class="btn btn-secondary"
                                                                                                                                target="_blank"
                                                                                                                                style="flex-grow: 1; margin: 0;">
                                                                                                                                Certificado
                                                                                                                            </a>

                                                                                                                            <form
                                                                                                                                action="/site/cancelar-inscricao"
                                                                                                                                method="POST"
                                                                                                                                onsubmit="return confirm('Tem certeza que deseja cancelar sua inscri√ß√£o neste evento?');"
                                                                                                                                style="flex-grow: 1; margin: 0;">

                                                                                                                                <input
                                                                                                                                    type="hidden"
                                                                                                                                    name="eventId"
                                                                                                                                    value="<%= event.id %>">

                                                                                                                                <button
                                                                                                                                    type="submit"
                                                                                                                                    class="btn btn-danger"
                                                                                                                                    style="width: 100%;">
                                                                                                                                    Cancelar
                                                                                                                                </button>
                                                                                                                            </form>

                                                                                                                        </div>
                                                                                                                    </div>
                                                                                                        </div>
                                                                                                        <% }) %>
                                                                                                </div>
                                                                                                <% } else { %>
                                                                                                    <div
                                                                                                        style="text-align: center;">
                                                                                                        <p>Voc√™ ainda
                                                                                                            n√£o se
                                                                                                            inscreveu em
                                                                                                            nenhum
                                                                                                            evento.
                                                                                                        </p>
                                                                                                        <a href="/site/eventos/todos"
                                                                                                            class="btn btn-secondary"
                                                                                                            style="margin-top: 1rem;">Ver
                                                                                                            Eventos
                                                                                                            Dispon√≠veis</a>
                                                                                                    </div>
                                                                                                    <% } %>
                                                                                    </div>
                                                                            </div>
                                                                            <% } %>
        </div>

        <%- include('partials/footer') %>