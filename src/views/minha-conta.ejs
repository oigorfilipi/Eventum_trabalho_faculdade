<%# Arquivo: src/views/minha-conta.ejs Este arquivo mostra dois layouts diferentes: 1. Se user.role=='admin' , mostra
    o 'stats' (Painel de Controle). 2. Senão, mostra 'myEvents' e infos do usuário (Perfil). %>

    <%- include('partials/header', { title: 'Minha Conta' }) %>

        <div class="container">

            <%# Exibe mensagens de erro/sucesso %>
                <% if (message) { %>
                    <div class="flash-message <%= message.type %>" style="margin-bottom: 1.5rem;">
                        <%= message.text %>
                    </div>
                    <% } %>

                        <%# --------------------------------------------------- %>
                            <%# 1. VISÃO DO ADMIN (Permanece igual) %>
                                <%# --------------------------------------------------- %>
                                    <% if (user.role==='admin' ) { %>
                                        <h1>Painel de Controle</h1>
                                        <p>Olá, admin <%= user.name %>. Aqui está um resumo do sistema.</p>

                                        <div class="form-container form-container-wide" style="margin-top: 2rem;">
                                            <h2>Estatísticas Rápidas</h2>
                                            <div class="admin-stats">
                                                <div class="stat-card">
                                                    <h3>
                                                        <%= stats.users %>
                                                    </h3>
                                                    <p>Usuários Totais</p>
                                                </div>
                                                <div class="stat-card">
                                                    <h3>
                                                        <%= stats.events %>
                                                    </h3>
                                                    <p>Eventos Ativos</p>
                                                </div>
                                                <div class="stat-card">
                                                    <h3>
                                                        <%= stats.activeSubscriptions %>
                                                    </h3>
                                                    <p>Inscrições Ativas</p>
                                                </div>
                                                <div class="stat-card">
                                                    <h3>
                                                        <%= stats.totalSubscriptions %>
                                                    </h3>
                                                    <p>Inscrições Totais (Histórico)</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-container form-container-wide" style="margin-top: 2rem;">
                                            <h2>Ações de Admin</h2>
                                            <div class="form-actions"
                                                style="flex-direction: column; align-items: stretch;">
                                                <a href="/site/eventos/novo" class="btn btn-success"
                                                    style="text-align: center;">+ Criar Novo Evento</a>
                                                <a href="/site/eventos/todos" class="btn-secondary"
                                                    style="text-align: center;">Gerenciar Eventos Existentes</a>
                                                <a href="/site/relatorio-admin" target="_blank" class="btn-secondary"
                                                    style="text-align: center;">Imprimir Relatório Geral</a>
                                                <a href="/site/admin/mensagens" class="btn-secondary"
                                                    style="text-align: center;">Ver Mensagens de Contato</a>
                                            </div>
                                        </div>

                                        <div class="form-container form-container-wide" style="margin-top: 2rem;">
                                            <h2>Gerar Certificados</h2>
                                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                                                Selecione um evento para gerar um certificado para todos os usuários
                                                inscritos.
                                            </p>
                                            <div class="certificate-list">
                                                <% if (events && events.length> 0) { %>
                                                    <% events.forEach(event=> { %>
                                                        <div class="certificate-item">
                                                            <span>
                                                                <%= event.title %>
                                                            </span>
                                                            <a href="/site/certificados/<%= event.id %>"
                                                                class="btn-secondary" target="_blank">Gerar</a>
                                                        </div>
                                                        <% }) %>
                                                            <% } else { %>
                                                                <p>Nenhum evento criado ainda.</p>
                                                                <% } %>
                                            </div>
                                        </div>

                                        <%# --------------------------------------------------- %>
                                            <%# 2. VISÃO DO USUÁRIO (NOVO LAYOUT DE ABAS) %>
                                                <%# --------------------------------------------------- %>
                                                    <% } else { %>
                                                        <h1>Minha Conta</h1>

                                                        <%# --- NAVEGAÇÃO DAS ABAS --- %>
                                                            <nav class="tab-navigation">
                                                                <button class="tab-button active"
                                                                    data-target="#tab-meus-dados">Meus Dados</button>
                                                                <button class="tab-button"
                                                                    data-target="#tab-seguranca">Privacidade e
                                                                    Segurança</button>
                                                                <button class="tab-button"
                                                                    data-target="#tab-meus-eventos">Meus Eventos
                                                                    Inscritos</button>
                                                            </nav>

                                                            <%# --- CONTEÚDO DAS ABAS --- %>

                                                                <%# Aba 1: Meus Dados %>
                                                                    <div class="tab-content active" id="tab-meus-dados">
                                                                        <div class="form-container form-container-wide">
                                                                            <h2>Meus Dados</h2>

                                                                            <form action="/site/atualizar-perfil"
                                                                                method="POST">

                                                                                <div class="form-group">
                                                                                    <label>Nome Completo (Não pode ser
                                                                                        alterado):</label>
                                                                                    <input type="text"
                                                                                        class="form-control"
                                                                                        value="<%= user.nome_completo %>"
                                                                                        disabled>
                                                                                </div>

                                                                                <div class="form-group">
                                                                                    <label for="name">Nome Social (Como
                                                                                        prefere ser chamado):</label>
                                                                                    <input type="text" id="name"
                                                                                        name="name" class="form-control"
                                                                                        value="<%= user.name %>"
                                                                                        required disabled>
                                                                                    <%# ADICIONADO 'disabled' %>
                                                                                </div>

                                                                                <div class="form-group">
                                                                                    <label
                                                                                        for="phone-mask">Telefone:</label>
                                                                                    <input type="tel" id="phone-mask"
                                                                                        name="phone"
                                                                                        class="form-control"
                                                                                        placeholder="(00) 0 0000-0000"
                                                                                        value="<%= user.phone || '' %>"
                                                                                        disabled>
                                                                                    <%# ADICIONADO 'disabled' %>
                                                                                </div>

                                                                                <div class="form-group">
                                                                                    <label>Email (Não pode ser
                                                                                        alterado):</label>
                                                                                    <input type="email"
                                                                                        class="form-control"
                                                                                        value="<%= user.email %>"
                                                                                        disabled>
                                                                                </div>

                                                                                <%# --- BOTÕES DE CONTROLE --- %>
                                                                                    <div class="form-actions"
                                                                                        id="profile-actions-view">
                                                                                        <button type="button"
                                                                                            class="btn-secondary"
                                                                                            id="edit-profile-btn">Alterar
                                                                                            Dados</button>
                                                                                    </div>

                                                                                    <div class="form-actions hidden"
                                                                                        id="profile-actions-edit">
                                                                                        <button type="submit"
                                                                                            class="btn btn-success">Salvar
                                                                                            Alterações</button>
                                                                                        <button type="button"
                                                                                            class="btn-secondary"
                                                                                            id="cancel-profile-btn">Cancelar</button>
                                                                                    </div>
                                                                            </form>
                                                                        </div>
                                                                    </div>

                                                                    <%# Aba 2: Privacidade e Segurança %>
                                                                        <div class="tab-content" id="tab-seguranca">

                                                                            <%# Formulário de Alterar Senha %>
                                                                                <div
                                                                                    class="form-container form-container-wide">
                                                                                    <%# <-- ADICIONE AQUI %>
                                                                                        <h2>Alterar Senha</h2>
                                                                                        <p
                                                                                            style="color: var(--text-secondary); margin-bottom: 1rem;">
                                                                                            A senha deve ter no mínimo 6
                                                                                            dígitos.</p>
                                                                                        <form action="/site/mudar-senha"
                                                                                            method="POST">
                                                                                            <div class="form-group">
                                                                                                <label
                                                                                                    for="senha-atual">Senha
                                                                                                    Atual:</label>
                                                                                                <input type="password"
                                                                                                    id="senha-atual"
                                                                                                    name="senhaAtual"
                                                                                                    class="form-control"
                                                                                                    required>
                                                                                            </div>
                                                                                            <div class="form-group">
                                                                                                <label
                                                                                                    for="nova-senha">Nova
                                                                                                    Senha:</label>
                                                                                                <input type="password"
                                                                                                    id="nova-senha"
                                                                                                    name="novaSenha"
                                                                                                    class="form-control"
                                                                                                    required
                                                                                                    minlength="6">
                                                                                            </div>
                                                                                            <button type="submit"
                                                                                                class="btn-secondary">Salvar
                                                                                                Nova Senha</button>
                                                                                        </form>
                                                                                </div>

                                                                                <%# Simulação de Termos e 2FA %>
                                                                                    <div class="form-container form-container-wide"
                                                                                        style="margin-top: 2rem;">
                                                                                        <%# <-- ADICIONE AQUI %>
                                                                                            <h2>Termos e Fatores de
                                                                                                Autenticação</h2>
                                                                                            <div class="form-group">
                                                                                                <p>Lorem ipsum dolor sit
                                                                                                    amet, consectetur
                                                                                                    adipiscing elit.
                                                                                                    Nullam
                                                                                                    in dui mauris.
                                                                                                    Vivamus
                                                                                                    hendrerit arcu sed
                                                                                                    erat
                                                                                                    molestie vehicula.
                                                                                                    Sed
                                                                                                    auctor neque eu
                                                                                                    tellus
                                                                                                    rhoncus, aenean.</p>
                                                                                            </div>

                                                                                            <form>
                                                                                                <%# Formulário simulado
                                                                                                    %>
                                                                                                    <div
                                                                                                        class="form-group checkbox-group">
                                                                                                        <input
                                                                                                            type="checkbox"
                                                                                                            id="termos-check">
                                                                                                        <label
                                                                                                            for="termos-check">Eu
                                                                                                            aceito os
                                                                                                            termos
                                                                                                            e
                                                                                                            condições</label>
                                                                                                    </div>
                                                                                                    <div
                                                                                                        class="form-group checkbox-group">
                                                                                                        <input
                                                                                                            type="checkbox"
                                                                                                            id="2fa-check">
                                                                                                        <label
                                                                                                            for="2fa-check">Ativar
                                                                                                            Autenticação
                                                                                                            de
                                                                                                            Dois Fatores
                                                                                                            (2FA)</label>
                                                                                                    </div>
                                                                                                    <div class="two-factor-box hidden"
                                                                                                        id="2fa-info-box">
                                                                                                        <p>A autenticação
                                                                                                            de
                                                                                                            dois fatores
                                                                                                            (2FA) ainda
                                                                                                            não
                                                                                                            está
                                                                                                            disponível,
                                                                                                            mas esta
                                                                                                            caixa
                                                                                                            apareceria
                                                                                                            quando você
                                                                                                            marcasse a
                                                                                                            opção.</p>
                                                                                                    </div>
                                                                                                    <button
                                                                                                        type="submit"
                                                                                                        class="btn-secondary"
                                                                                                        style="margin-top: 1rem;"
                                                                                                        disabled>Salvar
                                                                                                        Alterações
                                                                                                        (Simulado)</button>
                                                                                            </form>
                                                                                    </div>

                                                                                    <%# Zona de Perigo (Simulada) %>
                                                                                        <div class="form-container danger-zone form-container-wide"
                                                                                            style="margin-top: 2rem;">
                                                                                            <%# <-- ADICIONE AQUI %>
                                                                                                <h2>Zona de Perigo</h2>
                                                                                                <div
                                                                                                    style="display: flex; gap: 1rem; flex-wrap: wrap;">

                                                                                                    <%# --- BOTÃO
                                                                                                        DELETAR ATIVADO
                                                                                                        --- %>
                                                                                                        <form
                                                                                                            action="/site/deletar-conta"
                                                                                                            method="POST"
                                                                                                            onsubmit="return confirm('ATENÇÃO: Você tem certeza que deseja DELETAR sua conta? Esta ação é irreversível e todos os seus dados e inscrições serão perdidos.');">
                                                                                                            <button
                                                                                                                type="submit"
                                                                                                                class="btn btn-danger">Deletar
                                                                                                                Minha
                                                                                                                Conta</button>
                                                                                                        </form>

                                                                                                </div>
                                                                                        </div>
                                                                        </div>

                                                                        <%# Aba 3: Meus Eventos Inscritos %>
                                                                            <div class="tab-content"
                                                                                id="tab-meus-eventos">
                                                                                <%# Seção "Meus Eventos Inscritos" %>
                                                                                    <div
                                                                                        class="form-container form-container-wide">
                                                                                        <%# <-- ADICIONE AQUI %>
                                                                                            <h1>Meus Eventos Inscritos
                                                                                            </h1>
                                                                                            <% if (myEvents &&
                                                                                                myEvents.length> 0) { %>
                                                                                                <div class="event-list">
                                                                                                    <%
                                                                                                        myEvents.forEach(event=>
                                                                                                        { %>
                                                                                                        <div
                                                                                                            class="event-card">
                                                                                                            <% if
                                                                                                                (event.cover_image_url)
                                                                                                                { %>
                                                                                                                <a href="/site/eventos/<%= event.id %>"
                                                                                                                    class="event-card-image-link"
                                                                                                                    aria-hidden="true"
                                                                                                                    tabindex="-1">
                                                                                                                    <img src="<%= event.cover_image_url %>"
                                                                                                                        alt=""
                                                                                                                        class="event-card-image-novo">
                                                                                                                </a>
                                                                                                                <% } %>
                                                                                                                    <div
                                                                                                                        class="event-card-content">
                                                                                                                        <a href="/site/eventos/<%= event.id %>"
                                                                                                                            class="event-title-link">
                                                                                                                            <h3>
                                                                                                                                <%= event.title
                                                                                                                                    %>
                                                                                                                            </h3>
                                                                                                                        </a>
                                                                                                                        <p
                                                                                                                            style="color: var(--success-color); font-weight: bold; margin-top: auto;">
                                                                                                                            ✓
                                                                                                                            Inscrito
                                                                                                                        </p>
                                                                                                                    </div>
                                                                                                        </div>
                                                                                                        <% }) %>
                                                                                                </div>
                                                                                                <% } else { %>
                                                                                                    <div
                                                                                                        style="text-align: center;">
                                                                                                        <p>Você ainda
                                                                                                            não se
                                                                                                            inscreveu em
                                                                                                            nenhum
                                                                                                            evento.
                                                                                                        </p>
                                                                                                        <a href="/site/eventos/todos"
                                                                                                            class="btn-secondary"
                                                                                                            style="margin-top: 1rem;">Ver
                                                                                                            Eventos
                                                                                                            Disponíveis</a>
                                                                                                    </div>
                                                                                                    <% } %>
                                                                                    </div>
                                                                            </div>
                                                                            <% } %>
        </div>

        <%- include('partials/footer') %>