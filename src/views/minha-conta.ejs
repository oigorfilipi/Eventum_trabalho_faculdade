<%# Arquivo: src/views/minha-conta.ejs Este arquivo mostra dois layouts diferentes: 1. Se user.role=='admin' , mostra
    o 'stats' (Painel de Controle). 2. Senão, mostra 'myEvents' e infos do usuário (Perfil). %>

    <%- include('partials/header', { title: 'Minha Conta' }) %>

        <div class="container">

            <%# ADICIONE ESTE BLOCO DE MENSAGEM AQUI %>
                <% if (message) { %>
                    <div class="flash-message <%= message.type %>">
                        <%= message.text %>
                    </div>
                    <% } %>

                        <%# --------------------------------------------------- %>
                            <%# 1. VISÃO DO ADMIN %>
                                <%# --------------------------------------------------- %>
                                    <% if (user.role==='admin' ) { %>
                                        <h1>Painel de Controle</h1>
                                        <p>Olá, admin <%= user.name %>. Aqui está um resumo do sistema.</p>

                                        <div class="form-container" style="margin-top: 2rem;">
                                            <h2>Estatísticas Rápidas</h2>
                                            <div class="admin-stats">
                                                <div class="stat-card">
                                                    <h3>
                                                        <%= stats.users %>
                                                    </h3>
                                                    <p>Usuários Totais</p>
                                                </div>
                                                <div class="stat-card">
                                                    <h3>
                                                        <%= stats.events %>
                                                    </h3>
                                                    <p>Eventos Ativos</p>
                                                </div>

                                                <%# --- NOVOS CARDS DE INSCRIÇÃO --- %>
                                                    <div class="stat-card">
                                                        <h3>
                                                            <%= stats.activeSubscriptions %>
                                                        </h3>
                                                        <p>Inscrições Ativas</p>
                                                    </div>
                                                    <div class="stat-card">
                                                        <h3>
                                                            <%= stats.totalSubscriptions %>
                                                        </h3>
                                                        <p>Inscrições Totais (Histórico)</p>
                                                    </div>

                                            </div>
                                        </div>

                                        <div class="form-container" style="margin-top: 2rem;">
                                            <h2>Ações de Admin</h2>
                                            <a href="/site/eventos/novo" class="btn btn-success"
                                                style="margin-bottom: 1rem; text-align: center;">+ Criar Novo Evento</a>
                                            <a href="/site/eventos/todos" class="btn-secondary"
                                                style="text-align: center;">Gerenciar
                                                Eventos Existentes</a>

                                            <a href="/site/relatorio-admin" target="_blank" class="btn-secondary"
                                                style="margin-top: 1rem; text-align: center;">
                                                Imprimir Relatório Geral
                                            </a>

                                        </div>

                                        <%# --------------------------------------------------- %>
                                            <%# 2. VISÃO DO USUÁRIO COMUM %>
                                                <%# --------------------------------------------------- %>
                                                    <% } else { %>
                                                        <h1>Minha Conta</h1>

                                                        <%# CORREÇÃO: Envolvido em um <form> e campo "Nome" ativado %>
                                                            <form action="/site/atualizar-perfil" method="POST"
                                                                class="form-container" style="margin-top: 2rem;">
                                                                <h2>Minhas Informações</h2>

                                                                <div class="form-group">
                                                                    <label for="name">Nome:</label>
                                                                    <input type="text" id="name" name="name"
                                                                        class="form-control" value="<%= user.name %>"
                                                                        required>
                                                                </div>

                                                                <div class="form-group">
                                                                    <label>Email (Não pode ser alterado):</label>
                                                                    <input type="email" class="form-control"
                                                                        value="<%= user.email %>" disabled>
                                                                </div>

                                                                <button type="submit" class="btn btn-secondary">Salvar
                                                                    Alterações</button>
                                                            </form>


                                                            <div class="form-group">
                                                                <label>Email:</label>
                                                                <input type="email" class="form-control"
                                                                    value="<%= user.email %>" disabled>
                                                            </div>
        </div>

        <div class="form-container" style="margin-top: 2rem;">
            <h2>Alterar Senha</h2>

            <%# O <p> de aviso foi REMOVIDO daqui %>

                <form action="/site/mudar-senha" method="POST">
                    <div class="form-group">
                        <label for="senha-atual">Senha Atual:</label>
                        <input type="password" id="senha-atual" name="senhaAtual" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="nova-senha">Nova Senha:</label>
                        <input type="password" id="nova-senha" name="novaSenha" class="form-control" required>
                    </div>
                    <%# O 'disabled' foi REMOVIDO do botão %>
                        <button type="submit" class="btn btn-secondary">Salvar Nova
                            Senha</button>
                </form>
        </div>

        <div style="margin-top: 2rem;">
            <h1>Meus Eventos Inscritos</h1>

            <% if (myEvents && myEvents.length> 0) { %>
                <div class="event-list">
                    <% myEvents.forEach(event=> { %>

                        <div class="event-card">

                            <%# CORREÇÃO: Adicionado o link aqui %>
                                <a href="/site/eventos/<%= event.id %>" class="event-title-link">
                                    <h3>
                                        <%= event.title %>
                                    </h3>
                                </a>

                                <div class="date">
                                    <%= event.date ? new Date(event.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'
                                        }) : 'Data a definir' %>
                                </div>
                                <p>
                                    <%= event.description || 'Este evento não possui descrição.' %>
                                </p>
                                <p style="color: var(--success-color); font-weight: bold;">
                                    ✓ Inscrito</p>
                        </div>
                        <% }) %>
                </div>
                <% } else { %>
                    <div class="form-container">
                        <p>Você ainda não se inscreveu em nenhum evento.
                        </p>
                        <a href="/site/eventos" class="btn btn-secondary"
                            style="margin-top: 1rem; text-align: center;">Ver
                            Eventos Disponíveis</a>
                    </div>
                    <% } %>
        </div>
        <% } %>

            </div>

            <%- include('partials/footer') %>